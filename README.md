# Exam App

This app is an exam platform for dynamic, personalized exams. It is deployed via CloudFlare Workers at:

- [exam.sanand.workers.dev](https://exam.sanand.workers.dev)
- [exam.straive.app](https://exam.straive.app)

## Usage

- `https://exam.sanand.workers.dev/exam-{name}` to take the exam with a specific name
- `https://exam.sanand.workers.dev/results` to view results of exams
  - `?quiz={name}` to view latest results for a specific exam
  - `?email={email}` to view history of a specific user
  - `?history=true` to view history
  - `?page={page}` to paginate through results
  - `?limit={limit}` to limit the number of results per page
- `https://exam.sanand.workers.dev/resultsdump/` for a _complete_ dump of _all_ results saved so far (updated daily at 11:59 pm UTC = 5:29 am IST)

API:

- `POST /submit` submits the exam results with `{signature, ...params}` as the JSON body
- `POST /log` logs the exam access requests with `{quiz, email}` as the JSON body
- `GET /filter` filters the saved results with `?quiz={name}`, `?email={email}`, `?history=true`, `?page={page}`, `?limit={limit}`
- `GET /stats` summarizes the email IDs that viewed the exam
- `GET /proxy/https://...` and `POST /proxy/https://...` proxies GET and POST requests to external URLs

Source code (private): [github.com/gramener/exam](https://github.com/gramener/exam)

## File structure

- `src/`: Source code
  - `worker.js`: Server code to evaluate the exam
  - `exam.js`: Based on the URL, loads the `exam-*.js` and administers the exam
  - `exam-*.js`: Each exam's configuration. Compiles specific questions from `q-*.js`
  - `exam-*.info.js`: Each exam's instructions. Shown before the exam starts
  - `generate-info.js`: Compiles every exam's metadata + weights into `exam.info-generated.js`
  - `q-*.js`: Individual questions (the question bank)
  - `a-*.js`: Server-side answer validation modules for questions with `-server` suffix
  - `download.js`: Helper to download files
  - `utils/`:
    - `countdown.js`: Countdown timer
    - `display.js`: Display questions
    - `encrypt.js`: Encrypt, decrypt, and hash
    - `login.js`: Login with Google
- `public/`:
  - `index.html`: Landing page
  - `exam.html`: Exam page that loads `exam.js`
  - `results.html`: Results page - mainly for admins
  - `*.js`: Gitignored minified builds of `exam.js`, `exam-*.js`, and `download.js` built by `npm run build`
  - `*.json`: Gitignored generated data files for server-validated questions
- `src/exam.info-generated.js`: Gitignored artifact generated by `src/generate-info.js`
- `test/`: Test scripts to run the app

## Run

Local setup:

```bash
git clone https://github.com/gramener/exam.git
cd exam
git submodule update --init --recursive
npm install

npx wrangler dev
# Visit http://localhost:8787

# Skip data build
SKIP_DATA=1 npx wrangler dev

# Refresh compiled exam metadata + derived datasets
npm run build-data

# Run tests
npm test
```

Deploy:

```bash
npx wrangler deploy
# Visit https://exam.straive.app or https://exam.sanand.workers.dev
```

## Metadata aggregation

`src/generate-info.js` imports every `exam-*.info.js` along with the paired `exam-*.js`, extracts the `start`, `end`, and per-question `weight`, and writes the combined object to `src/exam.info-generated.js`. The script runs automatically as part of `npm run build-data`, but you can invoke it manually when editing exams:

```bash
node src/generate-info.js
```

The generated file is gitignored and can be re-created at any time.

## Add a new exam

To create an exam at `https://exam.sanand.workers.dev/{name}`, add two files:

1. `src/exam-{name}.js`: Defines the questions
2. `src/exam-{name}.info.js`: Defines exam metadata and instructions

### exam-{name}.js

```javascript
import { displayQuestions } from "./utils/display.js";

export async function questions(user, elementMap) {
  const results = [
    // Each import loads a separate question module
    // Can pass user data and weight to each question
    {
      ...(await import("./q-example1.js").then((m) =>
        m.default({
          user, // User data (email, etc) for personalization
          weight: 1, // Optional score weight for this question
        }),
      )),
      help: [html`...`, html`...`], // Optional docs / tutorials shown before the question
    },
  ];

  // 2. Render questions to the DOM
  displayQuestions(results, elementMap);

  // 3. Return question data for scoring
  // Converts [{id: 'q1', answer, weight}, ...] to {q1: {answer, weight}, ...}
  return Object.fromEntries(results.map(({ id, ...rest }) => [id, rest]));
}
```

### exam-{name}.info.js

```javascript
export default {
  // Basic exam settings
  title: "Exam Title",
  start: "2024-11-07T18:30:00+05:30", // When exam becomes available
  hours: 1.0, // Time limit

  // Access control
  admin: (email) => email == "admin@example.com", // Who can administer
  allowed: (email) => email.endsWith(".edu"), // Who can take exam

  // Pre-exam display
  instructions: /* html */ `
    <h1>Instructions</h1>
    <ol>
      <li>Rules...</li>
    </ol>
  `,
};
```

This module exports an object with the following fields:

- **title**: Display name of the exam
- **start**: ISO datetime string when exam starts
- **hours**: Duration in decimal hours
- **admin**: Optional function that returns true if user email is an admin
- **allowed**: Optional function that returns true if user email is allowed
- **instructions**: HTML content shown before exam starts

The exam will be available at `https://exam.sanand.workers.dev/{name}`.

## Add a new question

Questions are in `src/q-*.js`. Each question module exports a default async function that takes a config object with:

- `user`: User data (email, etc) for personalization
- `weight`: Optional score weight for this question (default: 1)

The function returns an object with:

```javascript
{
  id: "q-unique-id", // Unique question ID matching filename
  title: "Question Title", // Display title
  weight: 2, // Score weight
  question: html`...`, // lit-html template for question
  answer: (response) => bool, // Validation function
}
```

When writing new questions

- Keep code compact and deterministic.
- Use consistent randomization: `const random = seedrandom(`${user.email}#${id}`);`

Provide **clear Instructions**

```javascript
const question = html`
  <p>Clear description of the task</p>
  <ul>
    <li>Specific requirements</li>
  </ul>
  <div class="mb-3">
    <label for="${id}" class="form-label">Input instructions</label>
    <input class="form-control" id="${id}" name="${id}" />
  </div>
`;
```

Validate answers robustly.

```javascript
const answer = async (response) => {
  try {
    // Validate response format
    // Compare with expected results
    return true;
  } catch (error) {
    throw new Error("Helpful error message");
  }
};
```

The question will automatically be included in exams that import it.

## Server-side validated questions

Server-side validation prevents answer exposure in client code by validating answers on the server. This is useful for questions where:
- The answer can be easily reverse-engineered from client-side validation logic
- You want to prevent students from inspecting the code to find answers
- The validation requires server-side resources or data

### How it works

1. **Question module** (`src/q-{name}-server.js`):
   - Imports the answer module: `import answer from "./a-{name}.js"`
   - Uses seeded randomization: `seedrandom(\`${user.email}#${id}\`)`
   - Returns answer function: `answer: await answer(user)`

2. **Answer module** (`src/a-{name}.js`):
   - Exports default async function taking `user` parameter
   - Uses same seed as question to ensure consistency
   - Returns validator function that takes user's response
   - Validates and returns `true` or throws descriptive error

3. **Server validation** (`src/worker.js`):
   - Registers answer module in `answerModules` object (line 414)
   - When exam is submitted, calls answer validator for each server-validated question
   - Rejects entire submission if any server-validated answer is incorrect

### Two validation approaches

**Hash-based** (for pre-computed answers):
```javascript
// a-example-server.js
import { hash } from "./utils/encrypt.js";
import { answers } from "../public/data.json";

export default async function(user) {
  const random = seedrandom(`${user.email}#q-example-server`);
  const { hash: answerHash } = answers[Math.floor(random() * answers.length)];

  return async (response) => {
    const normalized = response.split(",").map(s => s.trim()).join(",");
    return answerHash === (await hash(normalized));
  };
}
```

**Computed** (for algorithmic answers):
```javascript
// a-example-server.js
export function generateScenario(user) {
  const random = seedrandom(`${user.email}#q-example-server`);
  // Generate problem and compute answer
  return { problem, answer };
}

export default async function(user) {
  return async (response) => {
    const { answer } = generateScenario(user);
    if (Number(response) !== answer) {
      throw new Error("Incorrect. Hint: check your calculation.");
    }
    return true;
  };
}
```

### Adding server-validated questions

1. Create `src/q-{name}-server.js` and `src/a-{name}.js`
2. Register in `src/worker.js` `answerModules` object:
   ```javascript
   const answerModules = {
     "q-{name}-server": await import("./a-{name}.js"),
   };
   ```
3. Use in exam by importing the question module

The answer is validated server-side during submission, preventing tampering or answer exposure.

## Difficulty

See [difficulty.md](./difficulty.md) for details on how difficult different questions are.

See [questions.md](./questions.md) for notes on how to apply these questions.

## Setup

Here are the steps used to set up the project:

- Add a domain `exam.sanand.workers.dev` via [CloudFlare Workers & Pages > `exam` > Settings > Domains & Routes > Add](https://dash.cloudflare.com/2c483e1dd66869c9554c6949a2d17d96/workers/services/view/exam/production/settings)
- Create a wrangler bucket `npx wrangler r2 bucket create exam`
- Modify [`wrangler.toml`](./wrangler.toml) to watch `src` directory and run `npm run build` to create minified builds in `public/`.

  ```toml
  # Watches for changes in the src directory and runs the build command
  [build]
  command = "npm run build"
  watch_dir = ["src"]
  ```

- [Set up Google Auth](https://console.cloud.google.com/apis/credentials/oauthclient/233761863432-t8g2u6esaeli8o2e2crvnu29u94ukt7k.apps.googleusercontent.com?project=tools-in-data-science) as `root.node@gmail.com` on project `tools-in-data-science`
  - Client ID: `233761863432-t8g2u6esaeli8o2e2crvnu29u94ukt7k.apps.googleusercontent.com`
  - Authorized JavaScript origins: https://exam.straive.app and https://exam.sanand.workers.dev and http://localhost:8787
- Create public-private keypair via `openssl genpkey -algorithm RSA -out private_key.pem -pkeyopt rsa_keygen_bits:2048`
  - Add `vars.PRIVATE_KEY` to [`wrangler.toml`](./wrangler.toml)
  - Add `public_key` to [`src/utils/encrypt.js`](./src/utils/encrypt.js)
