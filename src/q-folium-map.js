import { html } from "https://cdn.jsdelivr.net/npm/lit-html@3/lit-html.js";
import { default as seedrandom } from "seedrandom";

export default async function({ user, weight = 1.5 }) {
  const id = "q-folium-map";
  const title = "Geospatial Visualization: Logistics Density Heatmap";

  // Generate deterministic random data for the prompt
  const random = seedrandom(`${user.email}#${id}`);
  const cities = ["New York", "London", "Singapore", "Mumbai", "Tokyo"];
  const selectedCity = cities[Math.floor(random() * cities.length)];
  const pointCount = 50 + Math.floor(random() * 50); // Between 50 and 100 points

  const answer = async (response) => {
    try {
      const url = new URL(response);
      if (!url.hostname.includes("raw.githubusercontent.com")) {
        throw new Error("URL should be from raw.githubusercontent.com");
      }

      // 1. Validate README for email
      const readmeUrl = url.href; 
      // Assuming the user provides the URL to README.md, we derive the base path
      // Format: https://raw.githubusercontent.com/[user]/[repo]/[branch]/[folder]/README.md
      const pathParts = url.pathname.split('/');
      const fileName = pathParts.pop(); // Remove README.md

      if (fileName.toLowerCase() !== 'readme.md') {
         throw new Error("Please submit the raw URL of your README.md file");
      }

      const readmeResponse = await fetch(readmeUrl);
      if (!readmeResponse.ok) throw new Error("Could not fetch README.md");
      const readmeText = await readmeResponse.text();
      
      if (!readmeText.includes(user.email)) {
        throw new Error("README.md must contain your email address for verification.");
      }

      // Construct base URL for other files
      const baseUrl = url.origin + pathParts.join('/');

      // 2. Validate Python Script (map.py)
      const scriptResponse = await fetch(`${baseUrl}/map.py`);
      if (!scriptResponse.ok) throw new Error("Could not find 'map.py' in the same folder.");
      const scriptText = await scriptResponse.text();

      const scriptLower = scriptText.toLowerCase();
      if (!scriptLower.includes("folium")) throw new Error("Python script must import 'folium'.");
      if (!scriptLower.includes("heatmap")) throw new Error("Python script must use the 'HeatMap' plugin.");

      // 3. Validate HTML Map Output (map.html)
      const mapResponse = await fetch(`${baseUrl}/map.html`);
      if (!mapResponse.ok) throw new Error("Could not find the generated 'map.html' file.");
      const mapText = await mapResponse.text();

      if (!mapText.includes("leaflet")) throw new Error("The map.html file does not appear to be a valid Leaflet/Folium map.");

      return true;

    } catch (e) {
      throw new Error(`Validation Failed: ${e.message}`);
    }
  };

  const question = html`
    <div class="mb-3">
      <h2>Logistics Analytics: Delivery Density Heatmap</h2>
      <p>
        <strong>UrbanLogistics Inc.</strong> manages a fleet of delivery vehicles in <strong>${selectedCity}</strong>. 
        To optimize warehouse placement and driver allocation, the operations team needs to visualize areas with the 
        highest density of delivery events.
      </p>
      
      <p>
        Traditional scatter plots on a map are too cluttered when analyzing thousands of GPS pings. 
        The team has requested an <strong>Interactive Geospatial Heatmap</strong> using Python to identify "hotspots" 
        of delivery activity.
      </p>

      <h3>Your Task</h3>
      <p>
        Create a Python script using the <code>folium</code> library to generate an interactive HTML map.
      </p>

      <h4>Requirements</h4>
      <ol>
        <li>
          <strong>Generate Data:</strong> Create a Python list of ${pointCount} random latitude/longitude coordinates 
          centered roughly around ${selectedCity}.
        </li>
        <li>
          <strong>Create Map:</strong> Initialize a Folium map centered on the city.
        </li>
        <li>
          <strong>Add Heatmap:</strong> Use <code>folium.plugins.HeatMap</code> to visualize the density of the coordinates.
        </li>
        <li>
          <strong>Export:</strong> Save the map as <code>map.html</code>.
        </li>
      </ol>

      <h4>Repository Structure</h4>
      <p>Create a public GitHub repository folder containing:</p>
      <ul>
        <li><code>README.md</code>: Must contain your email address (<code>${user.email}</code>).</li>
        <li><code>map.py</code>: The Python script used to generate the map.</li>
        <li><code>map.html</code>: The output HTML file generated by the script.</li>
      </ul>

      <label for="${id}" class="form-label">
        Enter the <strong>Raw GitHub URL</strong> of your <code>README.md</code> file:
      </label>
      <input class="form-control" id="${id}" name="${id}" type="url" placeholder="https://raw.githubusercontent.com/..." required />
      <div class="form-text">
        Ensure your repository is public so the validation script can read your files.
      </div>
    </div>
  `;

  return { id, title, weight, question, answer };
}