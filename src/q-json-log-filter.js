import { html } from "https://cdn.jsdelivr.net/npm/lit-html@3/lit-html.js";
import { default as seedrandom } from "seedrandom";
import { download } from "./download.js";

export default async function ({ user, weight = 1 }) {
  const id = "q-json-log-filter";
  const title = "JSON Log Filtering";

  const random = seedrandom(`${user.email}#${id}`);

  const levels = ["INFO", "WARN", "ERROR"];
  const records = [];
  const lines = [];

  let expectedCount = 0;

  for (let i = 0; i < 120; i++) {
    const level = levels[Math.floor(random() * levels.length)];
    const timestamp = new Date(
      Date.now() - Math.floor(random() * 7 * 24 * 60 * 60 * 1000),
    ).toISOString();

    if (level === "ERROR") expectedCount++;

    const log = { timestamp, level, message: `Log message ${i}` };
    records.push(log);
    lines.push(JSON.stringify(log));
  }

  const blob = new Blob([lines.join("\n")], { type: "application/jsonl" });

  const answer = async (value) => {
    const n = Number(value);
    if (!Number.isInteger(n)) throw new Error("Enter a valid integer.");
    if (n !== expectedCount) {
      throw new Error("Incorrect count. Filter ERROR level logs only.");
    }
    return true;
  };

  const question = html`
    <div class="mb-3">
      <h2>Log Analysis for DevOps Monitoring</h2>
      <p>
        You are given a JSONL log file generated by a backend service.
        Each line is a JSON object with a timestamp and log level.
      </p>

      <ol>
        <li>Read the JSONL file line by line.</li>
        <li>Filter logs where <code>level === "ERROR"</code>.</li>
        <li>Count how many ERROR logs are present.</li>
      </ol>

      <p>
        Download the log file:
        <button class="btn btn-sm btn-outline-primary"
          @click=${() => download(blob, `${id}.jsonl`)}>
          ${id}.jsonl
        </button>
      </p>

      <label for="${id}" class="form-label">
        How many ERROR-level log entries are present?
      </label>
      <input class="form-control" id="${id}" name="${id}" required />
    </div>
  `;

  return { id, title, weight, question, answer };
}
